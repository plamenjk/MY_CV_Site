@model IEnumerable<MyCvSite.Models.Comment>

@{
    ViewData["Title"] = "Коментари";
}

<div class="container my-5">
    <div class="row g-4">
        <div class="col-md-5">
            <div class="glass-card p-4">
                <h3 class="mb-3">Остави коментар</h3>
                <p class="text-muted small mb-3">
                    Сподели впечатление за сайта, за проектите ми или просто поздрав.
                </p>
                <form id="commentForm">
                    <div class="mb-3">
                        <label for="authorName" class="form-label">Име</label>
                        <input type="text" id="authorName" class="form-control" placeholder="Име (по избор)" value="@(User.Identity?.IsAuthenticated == true ? User.Identity!.Name : string.Empty)" />
                    </div>
                    <div class="mb-3">
                        <label for="commentText" class="form-label">Коментар</label>
                        <textarea id="commentText" class="form-control" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-neo w-100">Добави коментар</button>
                </form>
            </div>
        </div>
        <div class="col-md-7">
            <div class="glass-card p-4">
                <h3 class="mb-3">Всички коментари</h3>
                <ul id="commentsList" class="list-group list-group-flush">
                    @foreach (var comment in Model)
                    {
                        <li class="list-group-item bg-transparent text-muted d-flex justify-content-between align-items-center border-secondary" data-id="@comment.Id">
                            <div>
                                <strong>@comment.AuthorName</strong><br />
                                @comment.Text<br />
                                <small class="text-muted">@comment.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-light like-btn btn-like-anim">
                                    ❤️ <span class="likes-count">@comment.LikesCount</span>
                                </button>
                            </div>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('commentForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const authorName = document.getElementById('authorName').value;
            const commentText = document.getElementById('commentText').value;

            if (!commentText.trim()) {
                alert('Моля, въведете коментар.');
                return;
            }

            fetch('/Comments/AddComment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    authorName: authorName,
                    text: commentText
                })
            })
            .then(res => {
                if (!res.ok) throw new Error('Грешка при добавяне на коментар');
                return res.json();
            })
            .then(data => {
                const li = document.createElement('li');
                li.className = 'list-group-item bg-transparent text-light d-flex justify-content-between align-items-center border-secondary';
                li.setAttribute('data-id', data.id);
                li.innerHTML = `
                    <div>
                        <strong>${data.authorName}</strong><br />
                        ${data.text}<br />
                        <small class="text-muted">${data.createdAt}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-light like-btn btn-like-anim">
                            ❤️ <span class="likes-count">${data.likesCount}</span>
                        </button>
                    </div>`;
                const list = document.getElementById('commentsList');
                list.insertBefore(li, list.firstChild);

                document.getElementById('commentText').value = '';
            })
            .catch(err => console.error(err));
        });

        document.addEventListener('click', function (e) {
            const likeBtn = e.target.closest('.like-btn');
            if (!likeBtn) return;

            const li = likeBtn.closest('li[data-id]');
            const id = li.getAttribute('data-id');

            likeBtn.classList.add('liked');
            setTimeout(() => likeBtn.classList.remove('liked'), 400);

            fetch('/Comments/Like', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: parseInt(id) })
            })
            .then(res => {
                if (!res.ok) throw new Error('Грешка при харесване');
                return res.json();
            })
            .then(data => {
                li.querySelector('.likes-count').textContent = data.likesCount;
            })
            .catch(err => console.error(err));
        });
    </script>
}
